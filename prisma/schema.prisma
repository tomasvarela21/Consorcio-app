generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}


enum AccountStatus {
  ON_TIME
  WITH_DEBT
}

enum ContactRole {
  INQUILINO
  RESPONSABLE
  PROPIETARIO
  INMOBILIARIA
}

enum ChargeStatus {
  PENDING
  PARTIAL
  PAID
}

enum PaymentStatus {
  COMPLETED
  CANCELLED
}

enum CreditMovementKind {
  CREDIT
  DEBIT
}

model Building {
  id          Int          @id @default(autoincrement())
  name        String
  address     String
  createdAt   DateTime     @default(now())
  units       Unit[]
  settlements Settlement[]

  @@map("buildings")
}

model Unit {
  id                Int                @id @default(autoincrement())
  buildingId        Int
  code              String
  padron            String?            @unique
  percentage        Decimal            @db.Decimal(10, 4)
  accountStatus     AccountStatus      @default(ON_TIME)
  creditBalance     Decimal            @default(0) @db.Decimal(12, 2)
  createdAt         DateTime           @default(now())
  building          Building           @relation(fields: [buildingId], references: [id])
  contacts          Contact[]
  settlementCharges SettlementCharge[]
  payments          Payment[]
  creditMovements   CreditMovement[]

  @@unique([buildingId, code])
  @@map("units")
}

model Contact {
  id        Int         @id @default(autoincrement())
  unitId    Int
  role      ContactRole
  fullName  String
  dni       String?
  phone     String?
  address   String?
  createdAt DateTime    @default(now())
  unit      Unit        @relation(fields: [unitId], references: [id])

  @@map("contacts")
}

model Settlement {
  id                Int                @id @default(autoincrement())
  buildingId        Int
  month             Int
  year              Int
  totalExpense      Decimal            @db.Decimal(12, 2)
  dueDate1          DateTime?
  dueDate2          DateTime?
  lateFeePercentage Decimal            @default(10) @db.Decimal(5, 2)
  createdAt         DateTime           @default(now())
  building          Building           @relation(fields: [buildingId], references: [id])
  charges           SettlementCharge[]
  payments          Payment[]
  creditMovements   CreditMovement[]

  @@unique([buildingId, month, year])
  @@map("settlements")
}

model SettlementCharge {
  id                   Int          @id @default(autoincrement())
  settlementId         Int
  unitId               Int
  previousBalance      Decimal      @db.Decimal(12, 2)
  currentFee           Decimal      @db.Decimal(12, 2)
  partialPaymentsTotal Decimal      @default(0) @db.Decimal(12, 2)
  totalToPay           Decimal      @db.Decimal(12, 2)
  status               ChargeStatus
  lateFeeFrozenAt      DateTime?
  lateFeeMonthsLate    Int?         @default(0)
  lateFeeAmount        Decimal      @default(0) @db.Decimal(12, 2)
  lateFeePaidTotal     Decimal      @default(0) @db.Decimal(12, 2)
  settlement           Settlement   @relation(fields: [settlementId], references: [id])
  unit                 Unit         @relation(fields: [unitId], references: [id])
  creditMovements      CreditMovement[]

  @@map("settlement_charges")
}

model Payment {
  id            Int        @id @default(autoincrement())
  settlementId  Int
  unitId        Int
  amount        Decimal    @db.Decimal(12, 2)
  receiptNumber String
  paymentDate   DateTime
  notes         String?
  createdAt     DateTime   @default(now())
  status        PaymentStatus @default(COMPLETED)
  canceledAt    DateTime?
  discountApplied Decimal  @default(0) @db.Decimal(12, 2)
  settlement    Settlement @relation(fields: [settlementId], references: [id])
  unit          Unit       @relation(fields: [unitId], references: [id])
  creditMovements CreditMovement[]

  @@map("payments")
}

model CreditMovement {
  id                 Int                 @id @default(autoincrement())
  unitId             Int                 @map("unit_id")
  paymentId          Int?                @map("payment_id")
  settlementId       Int?                @map("settlement_id")
  settlementChargeId Int?                @map("settlement_charge_id")
  movementDate       DateTime            @default(now()) @map("movement_date")
  amount             Decimal             @db.Decimal(12, 2)
  movementType       CreditMovementKind  @map("movement_type")
  description        String
  unit               Unit                @relation(fields: [unitId], references: [id])
  payment            Payment?            @relation(fields: [paymentId], references: [id])
  settlement         Settlement?         @relation(fields: [settlementId], references: [id])
  settlementCharge   SettlementCharge?   @relation(fields: [settlementChargeId], references: [id])

  @@map("credit_movements")
  @@index([unitId, movementDate])
}

model AdminUser {
  id           Int    @id
  email        String @unique
  passwordHash String

  @@map("admin_users")
}
